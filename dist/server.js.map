{"version":3,"sources":["../src/server.js"],"names":["logger","child","module","ABCIHandler","handlers","route","msgType","msgVal","result","ABCIConnection","msgHandler","c","connId","recvBuf","BL","isWaiting","writeData","dataBuf","write","err","emit","processRecvData","msgLen","msgLenRead","totalLen","length","msgBytes","slice","consume","info","mode","pause","respBuf","message","handlerResp","writing","on","resume","rawData","evt","toString","append","procErr","ABCIServer","appHandler","app","connector","server","net","createServer"],"mappings":"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","sourcesContent":["import net from 'net';\nimport pino from 'pino';\nimport BL from 'bl';\nimport { v4 as uuidv4 } from 'uuid';\nimport { decode as reqDecode, decodePadding } from './abci/msg_request';\nimport { encode as respEncode } from './abci/msg_response';\n\nconst logger = pino().child({ module: 'test-server' });\n\nconst ABCIHandler = (handlers) => {\n  const route = async (msgType, msgVal) => {\n    if (typeof handlers[msgType] === 'undefined') return {};\n    try {\n      const result = await handlers[msgType](msgVal);\n      return result;\n    } catch (handlerErr) {\n      // Depending on msgType, we will handle errors differently\n      throw handlerErr;\n    }\n  };\n  return {\n    route,\n  };\n};\n\nconst ABCIConnection = (msgHandler) => (c) => {\n  const connId = uuidv4();\n  const recvBuf = new BL();\n  let isWaiting = false;\n\n  const writeData = (dataBuf) => {\n    c.write(dataBuf, (err) => {\n      if (err) c.emit('error', err);\n    });\n  };\n\n  const processRecvData = async () => {\n    const { msgLen, msgLenRead } = decodePadding(recvBuf);\n    const totalLen = msgLen + msgLenRead;\n    if (recvBuf.length < totalLen) return; // Buffering\n    const msgBytes = recvBuf.slice(msgLenRead, totalLen);\n    recvBuf.consume(totalLen);\n    const {\n      msgType,\n      msgVal,\n    } = reqDecode(msgBytes, false);\n\n    logger.info({ connId, mode: 'request', msgType });\n    // logger.info({ msgType, msgVal });\n\n    c.pause();\n    isWaiting = true;\n\n    if (msgType === 'echo') {\n      // Echo back the message\n      const respBuf = respEncode({ msgType: 'echo', msgVal: { message: msgVal.message } });\n      writeData(respBuf);\n      c.emit('evt-done');\n      return;\n    }\n\n    if (msgType === 'flush') {\n      // Reply Flush\n      const respBuf = respEncode({ msgType: 'flush', msgVal: {} });\n      logger.info({ connId, mode: 'response', msgType: 'flush' });\n      writeData(respBuf);\n      c.emit('evt-done');\n      return;\n    }\n    try {\n      const handlerResp = await msgHandler.route(msgType, msgVal);\n      logger.info({\n        connId,\n        mode: 'response',\n        msgType,\n        writing: true,\n      });\n      const respBuf = respEncode({ msgType, msgVal: handlerResp });\n      writeData(respBuf);\n      logger.info({\n        connId,\n        mode: 'response',\n        msgType,\n        writing: false,\n      });\n      c.emit('evt-done');\n    } catch (handlerErr) {\n      if (handlerErr) {\n        c.emit('error', handlerErr);\n      }\n    }\n  };\n\n  c.on('evt-done', () => {\n    if (recvBuf.length > 0) {\n      processRecvData();\n      return;\n    }\n    isWaiting = false;\n    c.resume();\n  });\n\n  c.on('data', (rawData) => {\n    logger.info({\n      evt: 'onData',\n      rawData: rawData.toString('hex'),\n      isWaiting,\n    });\n    recvBuf.append(rawData);\n    if (isWaiting === true) return;\n    processRecvData()\n      .catch((procErr) => {\n        if (procErr) {\n          c.emit('error', procErr);\n        }\n      });\n  });\n\n  return {\n    writeData,\n  };\n};\n\nconst ABCIServer = (appHandler) => {\n  const app = ABCIHandler(appHandler);\n  const connector = ABCIConnection(app);\n\n  const server = net.createServer(connector);\n\n  return server;\n};\n\nexport default ABCIServer;\n"],"file":"server.js"}